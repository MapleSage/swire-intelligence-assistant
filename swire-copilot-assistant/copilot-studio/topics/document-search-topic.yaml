# Document Search Topic for Swire Intelligence Assistant
# Handles knowledge base searches and document retrieval

kind: AdaptiveDialog
beginDialog:
  kind: OnIntent
  intent: DocumentSearch
  actions:
    - kind: SetProperty
      property: conversation.topic
      value: "DocumentSearch"

    - kind: TextInput
      property: user.searchQuery
      prompt: |
        I can help you search through company documents and knowledge base. What are you looking for?

        Examples:
        â€¢ "Find safety procedures for offshore operations"
        â€¢ "Search HR policies about remote work"
        â€¢ "Locate maintenance manuals for wind turbines"
        â€¢ "Find financial reporting guidelines"
        â€¢ "Search environmental compliance documents"

      validations:
        - kind: Expression
          expression: "length(this.value) > 2"
          errorMessage: "Please provide at least 3 characters for the search."

    - kind: HttpRequest
      method: POST
      url: "${settings.CognitiveSearch.Endpoint}/indexes/${settings.CognitiveSearch.IndexName}/docs/search"
      headers:
        Authorization: "Bearer ${settings.CognitiveSearch.AccessToken}"
        Content-Type: "application/json"
        api-key: "${settings.CognitiveSearch.ApiKey}"
      body:
        search: "${user.searchQuery}"
        searchMode: "all"
        queryType: "semantic"
        semanticConfiguration: "swire-semantic-config"
        top: 5
        select: "id,title,content,source,department,documentType,lastModified,tags"
        highlight: "content"
        filter: "${if(entities.Department, `department eq '${entities.Department}'`, '')}"
      resultProperty: "conversation.searchResults"

    - kind: IfCondition
      condition: "conversation.searchResults.value && count(conversation.searchResults.value) > 0"
      actions:
        - kind: SendActivity
          activity: |
            ## ğŸ” Search Results for "${user.searchQuery}"

            Found **${count(conversation.searchResults.value)}** relevant documents:

            ${foreach(conversation.searchResults.value, result,
              `### ğŸ“„ ${result.title}\n**Source:** ${result.source} | **Department:** ${result.department}\n**Type:** ${result.documentType} | **Last Modified:** ${formatDate(result.lastModified)}\n\n**Summary:** ${substring(result.content, 0, 200)}...\n\n${if(result['@search.highlights'], `**Key Excerpts:**\n${join(result['@search.highlights'].content, '\n...\n')}\n`, '')}\n**Tags:** ${join(result.tags, ', ')}\n\n---\n`
            )}

        - kind: SuggestedActions
          actions:
            - title: "ğŸ” Refine Search"
              type: imBack
              value: "Search for more specific information"

            - title: "ğŸ“‚ Browse by Category"
              type: imBack
              value: "Show document categories"

            - title: "ğŸ“Š Related Documents"
              type: imBack
              value: "Find related documents"

            - title: "ğŸ’¾ Save Results"
              type: imBack
              value: "Save these search results"

      elseActions:
        - kind: SendActivity
          activity: |
            ## ğŸ” No Results Found

            I couldn't find any documents matching "${user.searchQuery}".

            **Suggestions:**
            â€¢ Try different keywords or phrases
            â€¢ Use broader search terms
            â€¢ Check spelling and try synonyms
            â€¢ Browse by document category or department

            **Available Document Categories:**
            ğŸ“‹ Policies & Procedures
            ğŸ›¡ï¸ Safety & HSE Documents  
            ğŸ‘¥ HR Guidelines & Forms
            ğŸ’° Financial Procedures
            ğŸ”§ Technical Manuals
            ğŸŒ Environmental Reports
            ğŸ“Š Operational Guidelines

        - kind: SuggestedActions
          actions:
            - title: "ğŸ“‚ Browse Categories"
              type: imBack
              value: "Show all document categories"

            - title: "ğŸ” New Search"
              type: imBack
              value: "Try a different search"

            - title: "ğŸ“ Contact Support"
              type: imBack
              value: "Contact document management team"

triggers:
  - kind: OnIntent
    intent: BrowseDocuments
    actions:
      - kind: SendActivity
        activity: |
          ## ğŸ“‚ Document Categories

          Browse documents by category:

          ğŸ›¡ï¸ **Safety & HSE**
          â€¢ Safety procedures and protocols
          â€¢ Incident reporting guidelines
          â€¢ Environmental compliance documents
          â€¢ Emergency response plans

          ğŸ‘¥ **Human Resources**
          â€¢ Employee policies and procedures
          â€¢ Training materials and guides
          â€¢ Performance management documents
          â€¢ Benefits and compensation info

          ğŸ’° **Finance & Accounting**
          â€¢ Financial reporting procedures
          â€¢ Budget planning guidelines
          â€¢ Expense management policies
          â€¢ Audit and compliance documents

          ğŸ”§ **Operations & Technical**
          â€¢ Equipment manuals and specifications
          â€¢ Maintenance procedures
          â€¢ Quality assurance guidelines
          â€¢ Technical standards and protocols

          ğŸ“Š **Corporate & Governance**
          â€¢ Corporate policies and procedures
          â€¢ Governance frameworks
          â€¢ Legal and regulatory documents
          â€¢ Strategic planning materials

      - kind: SuggestedActions
        actions:
          - title: "ğŸ›¡ï¸ Safety & HSE"
            type: imBack
            value: "Show safety and HSE documents"

          - title: "ğŸ‘¥ HR Documents"
            type: imBack
            value: "Show HR policies and procedures"

          - title: "ğŸ’° Finance Docs"
            type: imBack
            value: "Show financial procedures"

          - title: "ğŸ”§ Technical Manuals"
            type: imBack
            value: "Show technical documentation"

  - kind: OnIntent
    intent: RecentDocuments
    actions:
      - kind: HttpRequest
        method: POST
        url: "${settings.CognitiveSearch.Endpoint}/indexes/${settings.CognitiveSearch.IndexName}/docs/search"
        headers:
          Authorization: "Bearer ${settings.CognitiveSearch.AccessToken}"
          Content-Type: "application/json"
          api-key: "${settings.CognitiveSearch.ApiKey}"
        body:
          search: "*"
          top: 10
          select: "title,source,department,documentType,lastModified"
          orderby: "lastModified desc"
        resultProperty: "conversation.recentDocs"

      - kind: SendActivity
        activity: |
          ## ğŸ“… Recently Updated Documents

          ${foreach(conversation.recentDocs.value, doc,
            `ğŸ“„ **${doc.title}**\nğŸ“‚ ${doc.department} | ğŸ“‹ ${doc.documentType}\nğŸ“… Updated: ${formatDate(doc.lastModified)}\n`
          )}

  - kind: OnIntent
    intent: PopularDocuments
    actions:
      - kind: HttpRequest
        method: GET
        url: "${settings.PowerPlatform.DocumentAnalyticsUrl}/popular"
        headers:
          Authorization: "Bearer ${settings.PowerPlatform.AccessToken}"
        resultProperty: "conversation.popularDocs"

      - kind: SendActivity
        activity: |
          ## ğŸ“ˆ Most Accessed Documents

          ${foreach(conversation.popularDocs.documents, doc,
            `ğŸ“„ **${doc.title}**\nğŸ‘€ Views: ${doc.viewCount} | ğŸ“‚ ${doc.department}\nğŸ“‹ ${doc.documentType} | â­ Rating: ${doc.rating}/5\n`
          )}

entities:
  - name: DocumentType
    type: list
    values:
      - Policy
      - Procedure
      - Manual
      - Report
      - Form
      - Template
      - Guideline
      - Standard

  - name: DocumentCategory
    type: list
    values:
      - "Safety & HSE"
      - "Human Resources"
      - "Finance & Accounting"
      - "Operations"
      - "Technical"
      - "Legal & Compliance"
      - "Corporate Governance"
      - "Quality Assurance"

  - name: SearchScope
    type: list
    values:
      - "All Documents"
      - "Recent Updates"
      - "Popular Documents"
      - "My Department"
      - "Bookmarked Items"
