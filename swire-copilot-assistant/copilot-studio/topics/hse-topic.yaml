# HSE (Health, Safety, Environment) Topic for Swire Intelligence Assistant
# Handles safety incidents, compliance reports, and HSE analytics

kind: AdaptiveDialog
beginDialog:
  kind: OnIntent
  intent: HSEQuery
  actions:
    - kind: SetProperty
      property: conversation.topic
      value: "HSE"

    - kind: TextInput
      property: user.hseQuery
      prompt: |
        I can help you with Health, Safety & Environment information. What would you like to know?

        Examples:
        â€¢ Recent safety incidents and their status
        â€¢ HSE compliance metrics and trends
        â€¢ Safety performance by location or department
        â€¢ Environmental impact assessments
        â€¢ Incident investigation reports

      validations:
        - kind: Expression
          expression: "length(this.value) > 3"
          errorMessage: "Please provide more details about the HSE information you need."

    - kind: HttpRequest
      method: POST
      url: "${settings.PowerPlatform.HSEConnectorUrl}"
      headers:
        Authorization: "Bearer ${settings.PowerPlatform.AccessToken}"
        Content-Type: "application/json"
      body:
        query: "${user.hseQuery}"
        timeframe: "${entities.TimeFrame}"
        location: "${entities.Location}"
        severity: "${entities.Severity}"
        userId: "${user.id}"
      resultProperty: "conversation.hseData"

    - kind: IfCondition
      condition: "conversation.hseData.success == true"
      actions:
        - kind: SendActivity
          activity: |
            ## ğŸ›¡ï¸ HSE Summary

            **Period:** ${conversation.hseData.period}
            **Location:** ${conversation.hseData.location || 'All Sites'}

            ### Safety Metrics
            ğŸš¨ **Total Incidents:** ${conversation.hseData.totalIncidents}
            âš ï¸ **High Severity:** ${conversation.hseData.highSeverityIncidents}
            ğŸ“Š **Incident Rate:** ${conversation.hseData.incidentRate} per 100,000 hours
            ğŸ¯ **Days Since Last Incident:** ${conversation.hseData.daysSinceLastIncident}

            ### Compliance Status
            âœ… **Compliance Score:** ${conversation.hseData.complianceScore}%
            ğŸ“‹ **Audits Completed:** ${conversation.hseData.auditsCompleted}
            â° **Overdue Actions:** ${conversation.hseData.overdueActions}

            ### Recent Incidents
            ${foreach(conversation.hseData.recentIncidents, incident,
              `**${incident.date}** - ${incident.type} (${incident.severity})\nğŸ“ ${incident.location}\nğŸ“ ${incident.description}\nğŸ”„ Status: ${incident.status}\n`
            )}

            ${if(conversation.hseData.trends, 
              `### ğŸ“ˆ Trends & Insights\n${conversation.hseData.trends}`, 
              ''
            )}

        - kind: SuggestedActions
          actions:
            - title: "ğŸ“Š View Trends"
              type: imBack
              value: "Show HSE trends for the last 6 months"

            - title: "ğŸ” Incident Details"
              type: imBack
              value: "Show detailed incident analysis"

            - title: "ğŸ“ By Location"
              type: imBack
              value: "Compare safety performance by site"

            - title: "ğŸ“‹ Compliance Report"
              type: imBack
              value: "Generate HSE compliance report"

      elseActions:
        - kind: SendActivity
          activity: |
            I'm unable to retrieve HSE data at the moment. This might be due to:

            â€¢ System maintenance or temporary unavailability
            â€¢ Access restrictions for the requested information
            â€¢ Network connectivity issues

            Please try again shortly or contact the HSE team for urgent matters.

            **Error Details:** ${conversation.hseData.error}

triggers:
  - kind: OnIntent
    intent: HSEIncidents
    actions:
      - kind: HttpRequest
        method: GET
        url: "${settings.PowerPlatform.HSEConnectorUrl}/incidents"
        headers:
          Authorization: "Bearer ${settings.PowerPlatform.AccessToken}"
        resultProperty: "conversation.incidentData"

      - kind: SendActivity
        activity: |
          ## ğŸš¨ Recent Safety Incidents

          **Total Incidents (Last 30 days):** ${conversation.incidentData.total}
          **Open Investigations:** ${conversation.incidentData.openInvestigations}
          **Average Resolution Time:** ${conversation.incidentData.avgResolutionTime} days

          ### Incidents by Severity
          ${foreach(conversation.incidentData.bySeverity, severity,
            `${if(severity.level == 'Critical', 'ğŸ”´', if(severity.level == 'High', 'ğŸŸ ', if(severity.level == 'Medium', 'ğŸŸ¡', 'ğŸŸ¢')))} **${severity.level}:** ${severity.count} incidents`
          )}

          ### Recent Incidents
          ${foreach(conversation.incidentData.recent, incident,
            `**${formatDate(incident.date)}** - ${incident.type}\nğŸ“ ${incident.location} | ğŸ‘¤ ${incident.reportedBy}\nğŸ“ ${incident.shortDescription}\nğŸ”„ ${incident.status}\n`
          )}

  - kind: OnIntent
    intent: HSECompliance
    actions:
      - kind: HttpRequest
        method: GET
        url: "${settings.PowerPlatform.HSEConnectorUrl}/compliance"
        headers:
          Authorization: "Bearer ${settings.PowerPlatform.AccessToken}"
        resultProperty: "conversation.complianceData"

      - kind: SendActivity
        activity: |
          ## ğŸ“‹ HSE Compliance Status

          **Overall Compliance Score:** ${conversation.complianceData.overallScore}%
          **Last Audit Date:** ${formatDate(conversation.complianceData.lastAuditDate)}
          **Next Audit Due:** ${formatDate(conversation.complianceData.nextAuditDue)}

          ### Compliance by Category
          ${foreach(conversation.complianceData.categories, category,
            `${if(category.score >= 90, 'âœ…', if(category.score >= 75, 'âš ï¸', 'âŒ'))} **${category.name}:** ${category.score}%`
          )}

          ### Action Items
          ${foreach(conversation.complianceData.actionItems, action,
            `${if(action.priority == 'High', 'ğŸ”´', if(action.priority == 'Medium', 'ğŸŸ¡', 'ğŸŸ¢'))} **${action.title}**\nğŸ“… Due: ${formatDate(action.dueDate)}\nğŸ‘¤ Assigned: ${action.assignee}\n`
          )}

  - kind: OnIntent
    intent: HSETrends
    actions:
      - kind: HttpRequest
        method: GET
        url: "${settings.PowerPlatform.HSEConnectorUrl}/trends"
        headers:
          Authorization: "Bearer ${settings.PowerPlatform.AccessToken}"
        resultProperty: "conversation.trendData"

      - kind: SendActivity
        activity: |
          ## ğŸ“ˆ HSE Performance Trends

          **Trend Period:** ${conversation.trendData.period}
          **Overall Trend:** ${conversation.trendData.overallTrend} ${if(conversation.trendData.improving, 'ğŸ“ˆ Improving', 'ğŸ“‰ Needs Attention')}

          ### Key Metrics Trends
          ${foreach(conversation.trendData.metrics, metric,
            `**${metric.name}:** ${metric.currentValue} ${if(metric.trend == 'up', 'ğŸ“ˆ', if(metric.trend == 'down', 'ğŸ“‰', 'â¡ï¸'))} (${metric.changePercentage}% vs previous period)`
          )}

          ### Insights & Recommendations
          ${foreach(conversation.trendData.insights, insight,
            `ğŸ’¡ ${insight.description}\nğŸ“Š Impact: ${insight.impact}\nğŸ¯ Recommendation: ${insight.recommendation}\n`
          )}

entities:
  - name: IncidentType
    type: list
    values:
      - "Near Miss"
      - "First Aid"
      - "Medical Treatment"
      - "Lost Time Injury"
      - "Environmental Incident"
      - "Property Damage"
      - "Security Incident"

  - name: Severity
    type: list
    values:
      - Critical
      - High
      - Medium
      - Low

  - name: Location
    type: list
    values:
      - "All Sites"
      - "Offshore Wind Farm A"
      - "Offshore Wind Farm B"
      - "Onshore Operations"
      - "Maintenance Facility"
      - "Head Office"

  - name: ComplianceArea
    type: list
    values:
      - "Safety Management"
      - "Environmental Protection"
      - "Occupational Health"
      - "Emergency Preparedness"
      - "Training & Competency"
      - "Risk Assessment"
